<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket Audio Stream Test</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem;
      }
      #output {
        white-space: pre-wrap;
        border: 1px solid #ddd;
        padding: 1rem;
        height: 200px;
        overflow-y: scroll;
      }
      button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Audio Stream Test</h1>
    <button id="sendBtn">Send Audio</button>
    <div id="output"></div>

    <script>
      const testAudioFile = "test_audios/test_audio_60.wav";

      const output = document.getElementById("output");

      function log(msg) {
        output.textContent += msg + "\n";
        output.scrollTop = output.scrollHeight;
      }

      document.getElementById("sendBtn").addEventListener("click", async () => {
        log("⏳ Opening WebSocket…");
        const ws = new WebSocket("ws://localhost:3000/ws");
        ws.binaryType = "arraybuffer";

        ws.onopen = async () => {
          log("✅ Connected — fetching " + testAudioFile);

          try {
            const resp = await fetch(testAudioFile);
            if (!resp.ok) throw new Error(resp.statusText);
            const raw = await resp.arrayBuffer();
            log(`📤 Streaming ${raw.byteLength} bytes of audio…`);
            log(raw.byteLength);
            ws.send(raw);
            log("📨 Sent audio, sending END signal…");
            ws.send(JSON.stringify({ event: "END" }));
          } catch (err) {
            log("❌ Fetch/send error: " + err);
            ws.close();
          }
        };

        ws.onmessage = (evt) => {
          log("🗣️ Server: " + evt.data);
        };

        ws.onerror = (err) => {
          log("⚠️ WS error: " + err.message);
        };

        ws.onclose = () => {
          log("🔒 Connection closed");
        };
      });
    </script>
  </body>
</html>
